<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Beneficiarios Calificados - 250 BID</title>

  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTR9BMY="
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <style>
    :root{
      --bg:#f6f7fb;
      --panel:#ffffff;
      --text:#0f172a;
      --muted:#64748b;
      --border:#e2e8f0;
      --shadow: 0 10px 30px rgba(2,6,23,.08);
      --radius: 16px;
      --primary:#0b1220;
    }
    *{ box-sizing:border-box; }
    body{ margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; color:var(--text); background:var(--bg); }
    .app{
      height:100vh;
      display:grid;
      grid-template-columns: 340px 1fr 360px;
      gap:12px;
      padding:12px;
    }
    .panel{
      background:var(--panel);
      border:1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      min-width: 0;
    }
    .panel-header{
      padding:14px 14px 10px;
      border-bottom:1px solid var(--border);
    }
    .brand{
      display:flex;
      gap:10px;
      align-items:center;
    }
    .brand img{
      width:90px;
      height:auto;
      object-fit:contain;
    }
    h1{
      margin:0;
      font-size:18px;
      letter-spacing:.2px;
      font-weight:800;
    }
    .sub{
      margin:6px 0 0;
      color:var(--muted);
      font-size:12.5px;
      line-height:1.35;
    }
    .panel-body{
      padding:12px 14px;
      overflow:auto;
    }
    label{
      display:block;
      font-size:12px;
      font-weight:700;
      margin:12px 0 6px;
    }
    select, input{
      width:100%;
      padding:10px 10px;
      border:1px solid var(--border);
      border-radius:12px;
      outline:none;
      background:#fff;
      font-size:13px;
    }
    select:focus, input:focus{
      border-color:#94a3b8;
    }
    .btn{
      width:100%;
      margin-top:10px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--border);
      background:#fff;
      cursor:pointer;
      font-weight:700;
    }
    .btn.primary{
      background: var(--primary);
      border-color: var(--primary);
      color:#fff;
    }
    .stats{
      margin-top:12px;
      padding:10px 12px;
      border:1px dashed var(--border);
      border-radius:12px;
      font-size:12.5px;
      color:var(--text);
      line-height:1.45;
    }
    .legend{
      margin-top:12px;
      padding:10px 12px;
      border:1px solid var(--border);
      border-radius:12px;
    }
    .legend-title{
      font-weight:800;
      font-size:12.5px;
      margin-bottom:8px;
    }
    .legend-item{
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:center;
      padding:6px 0;
      border-bottom:1px solid #f1f5f9;
      font-size:12.5px;
    }
    .legend-item:last-child{ border-bottom:none; }
    .swatch{
      width:12px;height:12px;border-radius:50%;
      border:1px solid rgba(0,0,0,.18);
      flex:0 0 auto;
    }
    .legend-left{
      display:flex;
      align-items:center;
      gap:8px;
      min-width:0;
    }
    .muted{ color:var(--muted); }
    
#map{
  height: calc(100vh - 24px);  /* 100% alto de pantalla menos el padding del .app */
  width: 100%;
  border-radius: var(--radius);
  border:1px solid var(--border);
  box-shadow: var(--shadow);
  overflow:hidden;
  min-width:0;
}
html, body { height: 100%; }
    .detail{
      padding:14px;
    }
    .detail h2{
      margin:0 0 8px;
      font-size:15px;
      font-weight:900;
      letter-spacing:.2px;
    }
    .detail .hint{
      margin:0 0 12px;
      color:var(--muted);
      font-size:12.5px;
      line-height:1.35;
    }
    .card{
      border:1px solid var(--border);
      border-radius:14px;
      padding:12px;
      background:#fff;
    }
    .row{
      display:grid;
      grid-template-columns: 140px 1fr;
      gap:10px;
      padding:7px 0;
      border-bottom:1px solid #f1f5f9;
      font-size:13px;
      line-height:1.3;
    }
    .row:last-child{ border-bottom:none; }
    .k{ color:var(--muted); font-weight:700; }
    .v{ font-weight:700; color:var(--text); word-break:break-word; }
    .actions{
      display:flex;
      gap:10px;
      margin-top:12px;
    }
    .actions .btn{ margin-top:0; }
    @media (max-width: 1100px){
      .app{ grid-template-columns: 1fr; grid-template-rows: auto 55vh auto; }
      #map{ height:55vh; }
    }
  </style>
</head>

<body>
  <div class="app">
    <!-- LEFT PANEL -->
    <aside class="panel">
      <div class="panel-header">
        <div class="brand">
          <img src="logo_institucional.png" alt="Logo institucional" />
          <div>
            <h1>BENEFICIARIOS CALIFICADOS</h1>
            <p class="sub">Filtra por provincia, cantón y grupos. Haz clic en un punto para ver el detalle a la derecha.</p>
          </div>
        </div>
      </div>

      <div class="panel-body">
        <label for="selProvincia">Provincia</label>
        <select id="selProvincia"></select>

        <label for="selCanton">Cantón</label>
        <select id="selCanton"></select>

        <label for="selGrupo">Grupos</label>
        <select id="selGrupo"></select>

        <label for="txtBuscar">Buscar (CI / nombres)</label>
        <input id="txtBuscar" type="text" placeholder="Ej: 0400..., AGUIRRE..." />

        <button class="btn" id="btnLimpiar">Limpiar</button>

        <div class="stats" id="statsBox">
          <div><b>Total:</b> <span id="totalAll">0</span></div>
          <div><b>Mostrando:</b> <span id="totalShown">0</span></div>
          <div class="muted" style="margin-top:6px">
            Provincia: <span id="stProv">(Todas)</span><br/>
            Cantón: <span id="stCant">(Todos)</span><br/>
            Grupos: <span id="stGrp">(Todos)</span><br/>
            Búsqueda: <span id="stSearch">(Ninguna)</span>
          </div>
        </div>

        <div class="legend" id="legendBox">
          <div class="legend-title">Leyenda (GRUPOS)</div>
          <div id="legendItems"></div>
        </div>

        <div class="muted" style="margin-top:10px; font-size:12px;">
          Fuente: GeoJSON 250_BID.
        </div>
      </div>
    </aside>

    <!-- MAP -->
    <main id="map"></main>

    <!-- RIGHT PANEL -->
    <aside class="panel">
      <div class="detail">
        <h2>DETALLE DEL BENEFICIARIO</h2>
        <p class="hint">Selecciona un punto en el mapa para ver su información.</p>

        <div class="card" id="detailCard">
          <div class="muted" style="font-size:13px;">—</div>
        </div>

        <div class="actions">
          <button class="btn primary" id="btnCentrar" disabled>Centrar</button>
          <button class="btn" id="btnQuitar" disabled>Quitar selección</button>
        </div>
      </div>
    </aside>
  </div>

  <script>
    // =====================
    // Config
    // =====================
    const GEOJSON_URL = "250_BID.geojson";

    // Paleta de colores por grupo (si hay más grupos que colores, se reutilizan)
    const PALETTE = [
      "#ef4444","#3b82f6","#10b981","#a855f7","#f59e0b",
      "#06b6d4","#f43f5e","#22c55e","#6366f1","#84cc16"
    ];

    // Campos QGIS -> Etiquetas UI (con renombres)
    const FIELD_LABELS = [
      ["CI", "CI"],
      ["NOMBRES", "NOMBRES"],
      ["PROVINCIA", "PROVINCIA"],
      ["CANTON", "CANTÓN"],
      ["DISCAPACIDAD", "DISCAPACIDAD"],
      ["DIS_NUCLEO", "DISCAPACIDAD NÚCLEO FAMILIAR"],
      ["CALIFICA_BID", "CALIFICADO BID"],
      ["Grupos", "GRUPOS"]
    ];

    // =====================
    // Estado
    // =====================
    let map, baseLayer;
    let allFeatures = [];      // array of GeoJSON features
    let layerGroup = L.layerGroup(); // capa dinámica filtrada
    let groupColor = {};       // grupo -> color
    let selected = null;       // { feature, marker }

    // =====================
    // Utils
    // =====================
    const norm = (v) => (v ?? "").toString().trim().toUpperCase().replace(/\s+/g," ");

    function uniqSorted(arr){
      return [...new Set(arr)].filter(x => x !== "").sort((a,b)=>a.localeCompare(b,'es'));
    }

    function setSelectOptions(sel, values, allLabel="(Todas)"){
      sel.innerHTML = "";
      const optAll = document.createElement("option");
      optAll.value = "";
      optAll.textContent = allLabel;
      sel.appendChild(optAll);
      values.forEach(v=>{
        const o=document.createElement("option");
        o.value=v;
        o.textContent=v;
        sel.appendChild(o);
      });
    }

    function getProp(f, key){
      // soporta claves exactas y también variantes
      return f.properties ? f.properties[key] : undefined;
    }

    function computeGroupPalette(groups){
      groupColor = {};
      groups.forEach((g,i)=>{
        groupColor[g] = PALETTE[i % PALETTE.length];
      });
    }

    function markerStyleFor(feature){
      const g = norm(getProp(feature, "Grupos"));
      const color = groupColor[g] || "#64748b";
      return {
        radius: 6,
        fillColor: color,
        color: "rgba(0,0,0,.35)",
        weight: 1,
        fillOpacity: 0.9
      };
    }

    function buildDetail(feature){
      const card = document.getElementById("detailCard");
      card.innerHTML = "";

      FIELD_LABELS.forEach(([field, label])=>{
        const val = getProp(feature, field);
        const row = document.createElement("div");
        row.className = "row";
        row.innerHTML = `<div class="k">${label}</div><div class="v">${(val ?? "—")}</div>`;
        card.appendChild(row);
      });
    }

    function updateStats(shownCount){
      document.getElementById("totalAll").textContent = allFeatures.length;
      document.getElementById("totalShown").textContent = shownCount;

      const prov = document.getElementById("selProvincia").value || "(Todas)";
      const cant = document.getElementById("selCanton").value || "(Todos)";
      const grp  = document.getElementById("selGrupo").value || "(Todos)";
      const s    = document.getElementById("txtBuscar").value.trim() || "(Ninguna)";

      document.getElementById("stProv").textContent = prov;
      document.getElementById("stCant").textContent = cant;
      document.getElementById("stGrp").textContent  = grp;
      document.getElementById("stSearch").textContent = s;
    }

    function buildLegend(filteredFeatures){
      // counts por grupo en el conjunto filtrado
      const counts = {};
      filteredFeatures.forEach(f=>{
        const g = norm(getProp(f,"Grupos")) || "(SIN GRUPO)";
        counts[g] = (counts[g]||0) + 1;
      });

      // orden por nombre
      const groups = Object.keys(counts).sort((a,b)=>a.localeCompare(b,'es'));

      const container = document.getElementById("legendItems");
      container.innerHTML = "";

      groups.forEach(g=>{
        const div = document.createElement("div");
        div.className = "legend-item";
        const c = groupColor[g] || "#64748b";
        div.innerHTML = `
          <div class="legend-left" title="${g}">
            <span class="swatch" style="background:${c}"></span>
            <span style="white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:190px;">
              ${g}
            </span>
          </div>
          <div class="muted" style="font-weight:800;">${counts[g]}</div>
        `;
        container.appendChild(div);
      });
    }

    // =====================
    // Filtros
    // =====================
    function applyFilters(){
      const prov = norm(document.getElementById("selProvincia").value);
      const cant = norm(document.getElementById("selCanton").value);
      const grp  = norm(document.getElementById("selGrupo").value);
      const q    = norm(document.getElementById("txtBuscar").value);

      const filtered = allFeatures.filter(f=>{
        const fp = norm(getProp(f,"PROVINCIA"));
        const fc = norm(getProp(f,"CANTON"));
        const fg = norm(getProp(f,"Grupos"));
        const fci = norm(getProp(f,"CI"));
        const fn  = norm(getProp(f,"NOMBRES"));

        if (prov && fp !== prov) return false;
        if (cant && fc !== cant) return false;
        if (grp  && fg !== grp)  return false;

        if (q){
          // busca en CI o NOMBRES
          if (!(fci.includes(q) || fn.includes(q))) return false;
        }
        return true;
      });

      // repintar capa
      layerGroup.clearLayers();

      const geoLayer = L.geoJSON(filtered, {
        pointToLayer: (feature, latlng) => {
          const m = L.circleMarker(latlng, markerStyleFor(feature));
          m.on("click", () => onSelect(feature, m));
          return m;
        }
      });

      geoLayer.addTo(layerGroup);

      // stats + leyenda
      updateStats(filtered.length);
      buildLegend(filtered);

      // actualizar cantones según provincia (para UX)
      rebuildCantonOptions();

      // si el seleccionado queda fuera del filtro, limpiarlo
      if (selected){
        const stillThere = filtered.includes(selected.feature);
        if (!stillThere) clearSelection();
      }

      // zoom inicial si es primera vez
      if (filtered.length > 0 && !map._hasFitOnce){
        map.fitBounds(geoLayer.getBounds(), { padding:[30,30] });
        map._hasFitOnce = true;
      }
    }
setTimeout(() => map.invalidateSize(true), 200);

    function rebuildCantonOptions(){
      const selProv = norm(document.getElementById("selProvincia").value);
      const cantSel = document.getElementById("selCanton").value;

      const cantones = allFeatures
        .filter(f => !selProv || norm(getProp(f,"PROVINCIA")) === selProv)
        .map(f => (getProp(f,"CANTON") ?? "").toString().trim())
        .filter(Boolean);

      const cantonesUniq = uniqSorted(cantones);

      const sel = document.getElementById("selCanton");
      setSelectOptions(sel, cantonesUniq, "(Todos)");

      // re-seleccionar si aún existe
      if (cantSel && cantonesUniq.includes(cantSel)){
        sel.value = cantSel;
      }
    }

    // =====================
    // Selección
    // =====================
    function onSelect(feature, marker){
      selected = { feature, marker };

      // resaltar: aumentar radio
      marker.setStyle({ radius: 9, weight: 2 });

      buildDetail(feature);

      document.getElementById("btnCentrar").disabled = false;
      document.getElementById("btnQuitar").disabled = false;
    }

    function clearSelection(){
      if (selected && selected.marker){
        // restaurar estilo
        selected.marker.setStyle(markerStyleFor(selected.feature));
      }
      selected = null;

      document.getElementById("detailCard").innerHTML =
        `<div class="muted" style="font-size:13px;">—</div>`;

      document.getElementById("btnCentrar").disabled = true;
      document.getElementById("btnQuitar").disabled = true;
    }

    // =====================
    // Init
    // =====================
    async function init(){
      map = L.map("map", { zoomControl: true });
setTimeout(() => map.invalidateSize(true), 200);
window.addEventListener("resize", () => map.invalidateSize(true));
      
      baseLayer = L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19,
        attribution: "&copy; OpenStreetMap"
      }).addTo(map);

      layerGroup.addTo(map);

      // cargar geojson
      const res = await fetch(GEOJSON_URL);
      if (!res.ok) throw new Error("No se pudo cargar " + GEOJSON_URL);
      const data = await res.json();

      allFeatures = (data.type === "FeatureCollection") ? data.features : [];

      // preparar listas
      const provincias = uniqSorted(allFeatures.map(f => (getProp(f,"PROVINCIA") ?? "").toString().trim()).filter(Boolean));
      const cantones   = uniqSorted(allFeatures.map(f => (getProp(f,"CANTON") ?? "").toString().trim()).filter(Boolean));
      const grupos     = uniqSorted(allFeatures.map(f => norm(getProp(f,"Grupos"))).filter(Boolean));

      computeGroupPalette(grupos);

      setSelectOptions(document.getElementById("selProvincia"), provincias, "(Todas)");
      setSelectOptions(document.getElementById("selCanton"), cantones, "(Todos)");
      setSelectOptions(document.getElementById("selGrupo"), grupos, "(Todos)");

      // listeners
      document.getElementById("selProvincia").addEventListener("change", () => applyFilters());
      document.getElementById("selCanton").addEventListener("change", () => applyFilters());
      document.getElementById("selGrupo").addEventListener("change", () => applyFilters());

      let t=null;
      document.getElementById("txtBuscar").addEventListener("input", () => {
        clearTimeout(t);
        t = setTimeout(applyFilters, 200);
      });

      document.getElementById("btnLimpiar").addEventListener("click", () => {
        document.getElementById("selProvincia").value = "";
        document.getElementById("selCanton").value = "";
        document.getElementById("selGrupo").value = "";
        document.getElementById("txtBuscar").value = "";
        clearSelection();
        applyFilters();
      });

      document.getElementById("btnCentrar").addEventListener("click", () => {
        if (!selected) return;
        const ll = selected.marker.getLatLng();
        map.setView(ll, Math.max(map.getZoom(), 13), { animate:true });
      });

      document.getElementById("btnQuitar").addEventListener("click", () => clearSelection());

      // primera pintada
      updateStats(allFeatures.length);
      buildLegend(allFeatures);
      applyFilters();
    }

    init().catch(err=>{
      alert("Error: " + err.message);
      console.error(err);
    });
  </script>
</body>

</html>


